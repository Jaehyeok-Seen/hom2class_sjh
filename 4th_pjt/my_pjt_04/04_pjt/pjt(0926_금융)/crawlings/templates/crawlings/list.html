{% extends 'crawlings/base.html' %}
{% block title %}
  ì£¼ì‹ ëŒ“ê¸€ ë¶„ì„ê¸° - ê²°ê³¼
{% endblock %}

{% block content %}
  <div class="card">
    {% if company or code %}
      <h2 class="headline">
        {{ company|default:'ìµœê·¼ ì €ì¥' }}{% if code %}
          <span class="muted">({{ code }})</span>
        {% endif %}
      </h2>
    {% else %}
      <h2 class="headline">ì €ì¥ëœ ëŒ“ê¸€</h2>
    {% endif %}
    <p class="section-title">ìˆ˜ì§‘ëœ ëŒ“ê¸€:</p>

    <ul class="comments">
      {% for c in comments %}
        <li class="comment-item">
          <div class="comment-left">
            <div class="dot"></div>
            <div class="comment-body">
              <div class="comment-text">{{ c.content }}</div>
              <div class="comment-meta">{{ c.company_name }} Â· {{ c.stock_code }} Â· {{ c.created_at|date:'Y-m-d H:i' }}</div>
            </div>
          </div>
          <form action="{% url 'crawlings:delete' c.id %}?company={{ company|urlencode }}&code={{ code|urlencode }}" method="post">
            {% csrf_token %}
            <button class="btn-del" type="submit" aria-label="ëŒ“ê¸€ ì‚­ì œ">ì‚­ì œ</button>
          </form>
        </li>
      {% empty %}
        <li class="comment-item">
          <div class="comment-left">
            <div class="dot"></div>
            <div class="comment-body">
              <div class="comment-text muted">ì•„ì§ ì €ì¥ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>
  <div id="analysis-result" style="margin-top:20px; padding:20px; border:1px solid #444; border-radius:10px; display:none; background:#1e1e1e; color:#fff;">
    <h3 style="margin-bottom:15px;">ğŸ“Š ì—¬ë¡  ë¶„ì„ ê²°ê³¼</h3>
    <div id="analysis-cards" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;"></div>
  </div>

  <button id="analyze-btn" style="position:fixed; bottom:20px; right:20px; background-color:#222; color:#fff; border:none; padding:12px 20px; border-radius:8px; cursor:pointer;">ë¶„ì„</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("analyze-btn").addEventListener("click", async () => {
      const params = new URLSearchParams(window.location.search);
      const res = await fetch(`/crawlings/analyze/?${params.toString()}`);
      const data = await res.json();

      const resultBox = document.getElementById("analysis-result");
      const cardsContainer = document.getElementById("analysis-cards");

      if (data.result) {
          let parsed;
          try {
              parsed = JSON.parse(data.result); // ë¬¸ìì—´ â†’ JSON ê°ì²´ ë³€í™˜
          } catch(e) {
              // JSON íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ ë³´ì—¬ì¤Œ
              document.getElementById("analysis-text").textContent = data.result;
              resultBox.style.display = "block";
              return;
          }

          //  ì¹´í…Œê³ ë¦¬ë³„ ì¹´ë“œ ìƒì„±
          cardsContainer.innerHTML = "";
          for (const [key, value] of Object.entries(parsed)) {
              const card = document.createElement("div");
              card.style.background = "#2a2a2a";
              card.style.padding = "15px";
              card.style.borderRadius = "8px";
              card.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
              card.innerHTML = `<h4 style="margin-bottom:10px; color:#4fc3f7;">${key}</h4><p style="white-space:pre-wrap;">${value}</p>`;
              cardsContainer.appendChild(card);
          }

          resultBox.style.display = "block";
      } else {
          cardsContainer.innerHTML = `<p>${data.error || "ë¶„ì„ ì‹¤íŒ¨"}</p>`;
          resultBox.style.display = "block";
      }
  });
});
</script>
{% endblock %}
